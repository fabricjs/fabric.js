name: 'Update CHANGELOG.md file'
on:
  workflow_run:
    workflows: ['Check and create Changelog ðŸ“‹']
    types:
      - completed
permissions:
  contents: write
jobs:
  update_changelog:
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    runs-on: ubuntu-24.04
    steps:
      - name: 'Create an empty tmp directory'
        run: |
          mkdir ${{ runner.temp }}/artifacts
      - name: Recover build stats
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          name: changelog_artifact
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          path: ${{ runner.temp }}/artifacts
      - name: Parse the artifact in github output
        id: changelog_data
        run: |
          echo "log=$(cat ${{ runner.temp }}/artifacts/changelog_artifact.txt | jq -r '.log')" >> $GITHUB_OUTPUT
          echo "prev_log=$(cat ${{ runner.temp }}/artifacts/changelog_artifact.txt | jq -r '.prev_log')" >> $GITHUB_OUTPUT
          echo "full_name=$(cat ${{ runner.temp }}/artifacts/changelog_artifact.txt | jq -r '.full_name')" >> $GITHUB_OUTPUT
          echo "pr_ref=$(cat ${{ runner.temp }}/artifacts/changelog_artifact.txt | jq -r '.pr_ref')" >> $GITHUB_OUTPUT
      - name: Pull down the correct branch and repo
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7
        with:
          ref: ${{ steps.changelog_data.outputs.pr_ref }}
          repository: ${{ steps.changelog_data.outputs.full_name }}
          sparse-checkout: |
            CHANGELOG.md
            .prettierrc
            .prettierignore
      - name: Update CHANGELOG.md from PR title
        id: update
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v6.4.1
        env:
          log: '${{ steps.changelog_data.outputs.log }}'
          prev_log: '${{ steps.changelog_data.outputs.prev_log }}'
          next_version: next
        with:
          result-encoding: string
          script: |
            const fs = require('fs');
            const file = 'CHANGELOG.md';
            let content = fs.readFileSync(file).toString();
            const title = `[${process.env.next_version}]`;
            const log = process.env.log;
            const prev_log = process.env.prev_log;
            const prev_log_exists = prev_log && content.includes(prev_log);
            const log_exists = log && content.includes(log);
            let modified = false;
            if (!content.includes(title)) {
            const insertAt = content.indexOf('\n') + 1;
            content =
                content.slice(0, insertAt) +
                `\n## ${title}\n\n\n` +
                content.slice(insertAt);
            }

            if (prev_log_exists && log) {
                modified = true;
                content = content.replace(prev_log, log);
            } else if (log && !log_exists) {
                modified = true;
                const insertAt = content.indexOf('\n', content.indexOf(title) + title.length + 1) + 1;
                content = content.slice(0, insertAt) + log + '\n' + content.slice(insertAt);
            }
            fs.writeFileSync(file, content);
            return modified;
      - name: Setup node
        if: fromJson(steps.update.outputs.result)
        uses: actions/setup-node@1e60f620b9541d16bece96c5465dc8ee9832be0b # v4.0.4
        with:
          node-version: 24.x
      - name: Commit & Push
        if: fromJson(steps.update.outputs.result)
        run: |
          npx prettier --write CHANGELOG.md
          git diff
          git config user.name github-actions[bot]
          git config user.email github-actions[bot]@users.noreply.github.com
          git add CHANGELOG.md
          git commit -m "update CHANGELOG.md"
          git push
