name: 'Comment coverage on PR'
on:
  workflow_run:
    workflows: ['ðŸ§ª']
    types:
      - completed
jobs:
  coverage:
    env:
      unique_id: <!-- coverage-report -->
    name: Coverage reporting
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/cached-install
        with:
          node-version: 20.x
          install-system-deps: false
      - uses: actions/download-artifact@v4
        with:
          name: coverage-e2e
          run-id: ${{ github.event.workflow_run.id }}
          path: ./.nyc_output
      - uses: actions/download-artifact@v4
        with:
          name: coverage-vitest
          run-id: ${{ github.event.workflow_run.id }}
          path: ./.nyc_output
      - uses: actions/download-artifact@v4
        with:
          name: coverage-unit
          run-id: ${{ github.event.workflow_run.id }}
          path: ./.nyc_output
      - uses: actions/download-artifact@v4
        with:
          name: coverage-visual
          run-id: ${{ github.event.workflow_run.id }}
          path: ./.nyc_output
      - run: ls -l ./.nyc_output
      - name: Build the report
        id: report
        run: |
          npm run coverage:report > cov.txt
          echo "report=$(cat cov.txt)" >> $GITHUB_OUTPUT
      - name: Comment on PR for coverage
        uses: edumserrano/find-create-or-update-comment@v3.0.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.pull_request.number }}
          body-includes: '${{ env.unique_id }}'
          comment-author: 'github-actions[bot]'
          body: |
            ${{ env.unique_id }}
            ${{ steps.report.outputs.report }}
          edit-mode: replace
