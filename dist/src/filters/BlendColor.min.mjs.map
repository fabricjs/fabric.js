{"version":3,"file":"BlendColor.min.mjs","sources":["../../../src/filters/BlendColor.ts"],"sourcesContent":["import { Color } from '../color/Color';\nimport { BaseFilter } from './BaseFilter';\nimport type { T2DPipelineState, TWebGLUniformLocationMap } from './typedefs';\nimport { classRegistry } from '../ClassRegistry';\nimport { blendColorFragmentSource } from './shaders/blendColor';\n\nexport type TBlendMode =\n  | 'multiply'\n  | 'add'\n  | 'difference'\n  | 'screen'\n  | 'subtract'\n  | 'darken'\n  | 'lighten'\n  | 'overlay'\n  | 'exclusion'\n  | 'tint';\n\ntype BlendColorOwnProps = {\n  color: string;\n  mode: TBlendMode;\n  alpha: number;\n};\n\nexport const blendColorDefaultValues: BlendColorOwnProps = {\n  color: '#F95C63',\n  mode: 'multiply',\n  alpha: 1,\n};\n\n/**\n * Color Blend filter class\n * @example\n * const filter = new BlendColor({\n *  color: '#000',\n *  mode: 'multiply'\n * });\n *\n * const filter = new BlendImage({\n *  image: fabricImageObject,\n *  mode: 'multiply'\n * });\n * object.filters.push(filter);\n * object.applyFilters();\n * canvas.renderAll();\n */\nexport class BlendColor extends BaseFilter<'BlendColor', BlendColorOwnProps> {\n  /**\n   * Color to make the blend operation with. default to a reddish color since black or white\n   * gives always strong result.\n   * @type String\n   * @default\n   **/\n  declare color: BlendColorOwnProps['color'];\n\n  /**\n   * Blend mode for the filter: one of multiply, add, difference, screen, subtract,\n   * darken, lighten, overlay, exclusion, tint.\n   * @type String\n   * @default\n   **/\n  declare mode: BlendColorOwnProps['mode'];\n  /**\n   * alpha value. represent the strength of the blend color operation.\n   * @type Number\n   * @default\n   **/\n  declare alpha: BlendColorOwnProps['alpha'];\n\n  static defaults = blendColorDefaultValues;\n\n  static type = 'BlendColor';\n\n  static uniformLocations = ['uColor'];\n\n  getCacheKey() {\n    return `${this.type}_${this.mode}`;\n  }\n\n  protected getFragmentSource(): string {\n    return `\n      precision highp float;\n      uniform sampler2D uTexture;\n      uniform vec4 uColor;\n      varying vec2 vTexCoord;\n      void main() {\n        vec4 color = texture2D(uTexture, vTexCoord);\n        gl_FragColor = color;\n        if (color.a > 0.0) {\n          ${blendColorFragmentSource[this.mode]}\n        }\n      }\n      `;\n  }\n\n  /**\n   * Apply the Blend operation to a Uint8ClampedArray representing the pixels of an image.\n   *\n   * @param {Object} options\n   * @param {ImageData} options.imageData The Uint8ClampedArray to be filtered.\n   */\n  applyTo2d({ imageData: { data } }: T2DPipelineState) {\n    const source = new Color(this.color).getSource();\n    const tr = source[0] * this.alpha;\n    const tg = source[1] * this.alpha;\n    const tb = source[2] * this.alpha;\n    const alpha1 = 1 - this.alpha;\n\n    for (let i = 0; i < data.length; i += 4) {\n      const r = data[i];\n      const g = data[i + 1];\n      const b = data[i + 2];\n\n      switch (this.mode) {\n        case 'multiply':\n          data[i] = (r * tr) / 255;\n          data[i + 1] = (g * tg) / 255;\n          data[i + 2] = (b * tb) / 255;\n          break;\n        case 'screen':\n          data[i] = 255 - ((255 - r) * (255 - tr)) / 255;\n          data[i + 1] = 255 - ((255 - g) * (255 - tg)) / 255;\n          data[i + 2] = 255 - ((255 - b) * (255 - tb)) / 255;\n          break;\n        case 'add':\n          data[i] = r + tr;\n          data[i + 1] = g + tg;\n          data[i + 2] = b + tb;\n          break;\n        case 'difference':\n          data[i] = Math.abs(r - tr);\n          data[i + 1] = Math.abs(g - tg);\n          data[i + 2] = Math.abs(b - tb);\n          break;\n        case 'subtract':\n          data[i] = r - tr;\n          data[i + 1] = g - tg;\n          data[i + 2] = b - tb;\n          break;\n        case 'darken':\n          data[i] = Math.min(r, tr);\n          data[i + 1] = Math.min(g, tg);\n          data[i + 2] = Math.min(b, tb);\n          break;\n        case 'lighten':\n          data[i] = Math.max(r, tr);\n          data[i + 1] = Math.max(g, tg);\n          data[i + 2] = Math.max(b, tb);\n          break;\n        case 'overlay':\n          data[i] =\n            tr < 128\n              ? (2 * r * tr) / 255\n              : 255 - (2 * (255 - r) * (255 - tr)) / 255;\n          data[i + 1] =\n            tg < 128\n              ? (2 * g * tg) / 255\n              : 255 - (2 * (255 - g) * (255 - tg)) / 255;\n          data[i + 2] =\n            tb < 128\n              ? (2 * b * tb) / 255\n              : 255 - (2 * (255 - b) * (255 - tb)) / 255;\n          break;\n        case 'exclusion':\n          data[i] = tr + r - (2 * tr * r) / 255;\n          data[i + 1] = tg + g - (2 * tg * g) / 255;\n          data[i + 2] = tb + b - (2 * tb * b) / 255;\n          break;\n        case 'tint':\n          data[i] = tr + r * alpha1;\n          data[i + 1] = tg + g * alpha1;\n          data[i + 2] = tb + b * alpha1;\n      }\n    }\n  }\n\n  /**\n   * Send data from this filter to its shader program's uniforms.\n   *\n   * @param {WebGLRenderingContext} gl The GL canvas context used to compile this filter's shader.\n   * @param {Object} uniformLocations A map of string uniform names to WebGLUniformLocation objects\n   */\n  sendUniformData(\n    gl: WebGLRenderingContext,\n    uniformLocations: TWebGLUniformLocationMap,\n  ) {\n    const source = new Color(this.color).getSource();\n    source[0] = (this.alpha * source[0]) / 255;\n    source[1] = (this.alpha * source[1]) / 255;\n    source[2] = (this.alpha * source[2]) / 255;\n    source[3] = this.alpha;\n    gl.uniform4fv(uniformLocations.uColor, source);\n  }\n}\n\nclassRegistry.setClass(BlendColor);\n"],"names":["blendColorDefaultValues","color","mode","alpha","BlendColor","BaseFilter","getCacheKey","concat","this","type","getFragmentSource","blendColorFragmentSource","applyTo2d","_ref","imageData","data","source","Color","getSource","tr","tg","tb","alpha1","i","length","r","g","b","Math","abs","min","max","sendUniformData","gl","uniformLocations","uniform4fv","uColor","_defineProperty","classRegistry","setClass"],"mappings":"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"}